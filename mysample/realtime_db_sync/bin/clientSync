#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'net/http'
require 'uri'
require 'open-uri'
require 'fileutils'
require 'libdb'
require 'libutil'

SERVER_HOST='localhost'

def sync_db( username )
  puts "sync db..."
  masterList = open( sprintf( "http://%s:8081/getList?username=%s", SERVER_HOST, username ), "r" ) {|f|
    f.readlines
  }
  # open local db
  localdb = DBSync::LocalDB.new( File.expand_path( "~/.localdb/" ))
  localdb.open( username )

  # calc difference between master and local.
  localList = localdb.getList() 
  util = DBSync::Util.new
  diffList = util.diffList( masterList, localList )

  diffList.each {|e|
    puts "entry: #{e}"
  }
end

def wait_notify( username )
  uri = URI.parse("http://localhost:8080/?username=#{username}")
  Net::HTTP.start(uri.host, uri.port) do |http|
    request = Net::HTTP::Get.new(uri.request_uri)
    http.request(request) do |response|
      raise 'Response is not chuncked' unless response.chunked?
      response.read_body do |chunk|
        puts "#{chunk}"
        return chunk.chomp
      end
    end
  end
end


def main
  if 1 > ARGV.length
    puts "usage: clientdb.rb [USERNAME]"
    exit 1
  end
  result = wait_notify( ARGV[0] )
  if result
    sync_db( ARGV[0] )
  end
end

main
